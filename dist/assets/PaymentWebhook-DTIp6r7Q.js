import{L as B,K as C,r as y,o as P,c as l,E as d,l as e,H as u,z as p,k as v,q as n,M as I}from"./vendor-Cn5j0SEu.js";import{b as N,u as T,r as W}from"./index-DyprfSbd.js";import{p as R}from"./paymentNotificationService-DMPYb6UY.js";import{r as k}from"./CheckCircleIcon-9dtlsCvY.js";import{r as S}from"./ClockIcon-A7fuk63B.js";import{f as q,l as $}from"./index-BoRhMNJp.js";import"./excel-C9Ruqv6W.js";const K={class:"min-h-screen bg-gray-50 flex items-center justify-center p-4"},L={class:"max-w-md w-full"},E={key:0,class:"text-center"},O={class:"w-16 h-16 bg-success-100 rounded-full flex items-center justify-center mx-auto mb-4"},V={class:"card p-6 text-left mb-6"},H={class:"space-y-2 text-sm"},U={key:0,class:"flex justify-between border-b pb-2 mb-2"},F={class:"font-medium"},G={class:"flex justify-between"},J={class:"font-medium"},z={class:"flex justify-between"},Q={class:"font-medium font-mono"},Y={class:"flex justify-between"},X={class:"font-medium"},Z={class:"flex justify-between"},ee={class:"font-medium"},te={key:0,class:"mt-4 p-3 bg-green-50 rounded-lg"},se={class:"flex items-center text-green-800"},ae={class:"text-sm"},oe={key:1,class:"text-center"},re={class:"w-16 h-16 bg-warning-100 rounded-full flex items-center justify-center mx-auto mb-4"},ne={key:2,class:"text-center"},ie={class:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"},le={class:"text-gray-600 mb-6"},de={key:3,class:"text-center"},_e={__name:"PaymentWebhook",setup(me){const m=B(),w=C(),D=N(),b=T(),c=y("loading"),a=y({}),f=y(""),h=s=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(s),_=s=>q(new Date(s),"dd MMMM yyyy, HH:mm",{locale:$}),M=s=>s?{qris:"QRIS",bca:"Transfer BCA",mandiri:"Transfer Mandiri",bni:"Transfer BNI",bri:"Transfer BRI",gopay:"GoPay",ovo:"OVO",dana:"DANA",linkaja:"LinkAja"}[s.toLowerCase()]||s.toUpperCase():"Transfer Bank",x=async()=>{var s,t,r;try{c.value="processing";const o={amount:parseInt(m.query.amount),order_id:m.query.order_id,project:m.query.project,status:m.query.status,payment_method:m.query.payment_method,completed_at:m.query.completed_at||new Date().toISOString()};if(!o.amount||!o.order_id)throw new Error("Data pembayaran tidak lengkap");console.log("Processing webhook for order:",o.order_id);const i=await R.processPaymentWebhook(o);if(i.success)await D.handlePaymentWebhook(o),a.value={...o,student_name:(s=i.student)==null?void 0:s.name,student_nickname:(t=i.student)==null?void 0:t.nickname},c.value="success",b.success(`ðŸŽ‰ Pembayaran berhasil! Notifikasi WhatsApp telah dikirim ke ${(r=i.student)==null?void 0:r.name}`);else throw new Error("Gagal memproses webhook")}catch(o){console.error("Webhook processing error:",o),f.value=o.message||"Gagal memproses pembayaran",c.value="error",b.error("Pembayaran diterima tapi gagal kirim notifikasi WhatsApp")}},g=()=>{w.push("/")},j=()=>{x()},A=()=>{var i;const s={orderid:a.value.order_id,amount:a.value.amount,payment_method:a.value.payment_method,completed_at:a.value.completed_at},t=`
BUKTI PEMBAYARAN
Kas Kelas 1B SD Islam Al Husna

Order ID: ${s.orderid}
Jumlah: ${h(s.amount)}
Metode: ${(i=s.payment_method)==null?void 0:i.toUpperCase()}
Waktu: ${_(s.completed_at)}

Terima kasih atas pembayaran Anda!
  `.trim(),r=document.createElement("a"),o=new Blob([t],{type:"text/plain"});r.href=URL.createObjectURL(o),r.download=`receipt-${s.orderid}.txt`,document.body.appendChild(r),r.click(),document.body.removeChild(r)};return P(()=>{x()}),(s,t)=>(d(),l("div",K,[e("div",L,[c.value==="success"?(d(),l("div",E,[e("div",O,[u(p(k),{class:"w-8 h-8 text-success-600"})]),t[6]||(t[6]=e("h1",{class:"text-2xl font-semibold text-gray-900 mb-2"},"Pembayaran Berhasil!",-1)),t[7]||(t[7]=e("p",{class:"text-gray-600 mb-6"},"Terima kasih, pembayaran Anda telah berhasil diproses.",-1)),e("div",V,[t[5]||(t[5]=e("h3",{class:"font-semibold text-gray-900 mb-3"},"Detail Pembayaran",-1)),e("div",H,[a.value.student_name?(d(),l("div",U,[t[0]||(t[0]=e("span",{class:"text-gray-600"},"Siswa:",-1)),e("span",F,n(a.value.student_name)+" ("+n(a.value.student_nickname)+")",1)])):v("",!0),e("div",G,[t[1]||(t[1]=e("span",{class:"text-gray-600"},"Jumlah:",-1)),e("span",J,n(h(a.value.amount)),1)]),e("div",z,[t[2]||(t[2]=e("span",{class:"text-gray-600"},"Order ID:",-1)),e("span",Q,n(a.value.order_id),1)]),e("div",Y,[t[3]||(t[3]=e("span",{class:"text-gray-600"},"Metode:",-1)),e("span",X,n(M(a.value.payment_method)),1)]),e("div",Z,[t[4]||(t[4]=e("span",{class:"text-gray-600"},"Waktu:",-1)),e("span",ee,n(_(a.value.completed_at)),1)])]),a.value.student_name?(d(),l("div",te,[e("div",se,[u(p(k),{class:"w-4 h-4 mr-2"}),e("span",ae,"âœ… Notifikasi WhatsApp telah dikirim ke "+n(a.value.student_name),1)])])):v("",!0)]),e("div",{class:"space-y-3"},[e("button",{onClick:g,class:"btn-primary w-full"}," Kembali ke Dashboard "),e("button",{onClick:A,class:"btn-secondary w-full"}," Download Bukti Pembayaran ")])])):c.value==="processing"?(d(),l("div",oe,[e("div",re,[u(p(S),{class:"w-8 h-8 text-warning-600 animate-spin"})]),t[8]||(t[8]=I('<h1 class="text-2xl font-semibold text-gray-900 mb-2">Memproses Pembayaran</h1><p class="text-gray-600 mb-6">Mohon tunggu, kami sedang memverifikasi pembayaran Anda...</p><div class="card p-6"><div class="flex items-center space-x-3"><div class="w-3 h-3 bg-warning-500 rounded-full animate-pulse"></div><span class="text-sm text-gray-600">Verifikasi pembayaran...</span></div></div>',3))])):c.value==="error"?(d(),l("div",ne,[e("div",ie,[u(p(W),{class:"w-8 h-8 text-red-600"})]),t[9]||(t[9]=e("h1",{class:"text-2xl font-semibold text-gray-900 mb-2"},"Terjadi Kesalahan",-1)),e("p",le,n(f.value),1),e("div",{class:"space-y-3"},[e("button",{onClick:j,class:"btn-primary w-full"}," Coba Lagi "),e("button",{onClick:g,class:"btn-secondary w-full"}," Kembali ke Dashboard ")])])):(d(),l("div",de,t[10]||(t[10]=[e("div",{class:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"},[e("div",{class:"w-6 h-6 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"})],-1),e("h1",{class:"text-2xl font-semibold text-gray-900 mb-2"},"Loading...",-1),e("p",{class:"text-gray-600"},"Memuat informasi pembayaran...",-1)])))])]))}};export{_e as default};
